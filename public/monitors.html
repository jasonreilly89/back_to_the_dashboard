<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Runtime Monitors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="/vendor/chart.js/chart.umd.min.js?v=20250916"></script>
    <style>
      body { background:#f8f9fa; }
      .card { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
      .badge-key { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h4 m-0">Runtime Monitors</h1>
          <div class="text-muted small" id="srcInfo">Loading…</div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="/">Dashboard</a>
          <button id="refreshBtn" class="btn btn-primary btn-sm">Refresh</button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card p-3 h-100">
            <h5 class="h6">p_change Distribution</h5>
            <canvas id="histChart" height="160"></canvas>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card p-3 h-100">
            <h5 class="h6">State Counters</h5>
            <div class="row text-center">
              <div class="col"><div class="text-muted">Entries</div><div class="h4" id="kpiEntries">—</div></div>
              <div class="col"><div class="text-muted">Exits</div><div class="h4" id="kpiExits">—</div></div>
              <div class="col"><div class="text-muted">Open</div><div class="h4" id="kpiOpen">—</div></div>
            </div>
            <div class="mt-2 small text-muted" id="rlStats">—</div>
          </div>
        </div>
      </div>

      <div class="card p-3 mt-3">
        <h5 class="h6">Raw JSON</h5>
        <pre id="raw" class="bg-dark text-light p-2" style="max-height: 50vh; overflow:auto"></pre>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let histChart = null;
      async function json(url) { const r = await fetch(url, { cache:'no-store' }); if (!r.ok) throw new Error(r.status); return r.json(); }

      function renderHist(hist){
        const arr = Array.isArray(hist) ? hist : [];
        const labels = arr.map(b => (b.bin!==undefined? String(b.bin) : (b.bin_low!==undefined && b.bin_high!==undefined ? `${b.bin_low}–${b.bin_high}` : '')));
        const data = arr.map(b => Number(b.count||b.n||0));
        const ctx = $('histChart').getContext('2d');
        const opts = { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } };
        if (!histChart) histChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor:'#6c8ef5' }] }, options: opts });
        else { histChart.data.labels = labels; histChart.data.datasets[0].data = data; histChart.update('none'); }
      }

      async function refresh(){
        try {
          const js = await json('/api/monitors/runtime');
          $('srcInfo').textContent = js.source ? `Source: ${js.source}` : 'No runtime metrics yet';
          const d = js.data || {};
          renderHist(d.p_change_hist || d.p_change || []);
          $('kpiEntries').textContent = d.entries != null ? d.entries : (d.states && d.states.entries != null ? d.states.entries : '—');
          $('kpiExits').textContent = d.exits != null ? d.exits : (d.states && d.states.exits != null ? d.states.exits : '—');
          $('kpiOpen').textContent = d.open_positions != null ? d.open_positions : (d.states && d.states.open != null ? d.states.open : '—');
          const rl = d.run_length || d.runlen || {};
          const parts = [];
          if (rl.mean!=null) parts.push(`mean ${Number(rl.mean).toFixed(1)}`);
          if (rl.p50!=null) parts.push(`p50 ${Number(rl.p50).toFixed(0)}`);
          if (rl.p90!=null) parts.push(`p90 ${Number(rl.p90).toFixed(0)}`);
          if (rl.max!=null) parts.push(`max ${Number(rl.max).toFixed(0)}`);
          $('rlStats').textContent = parts.length ? ('Run-length: ' + parts.join(' · ')) : '—';
          $('raw').textContent = JSON.stringify(d, null, 2);
        } catch (e) {
          $('srcInfo').textContent = 'Failed to load runtime metrics';
        }
      }

      $('refreshBtn').onclick = refresh;
      refresh();
    </script>
  </body>
 </html>
