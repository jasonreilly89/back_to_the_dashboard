<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kanban Tasks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background:#f8f9fa; }
      .card { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
      .badge-epic { background:#eef2ff; color:#3730a3; }
      .task-title { font-weight:600; }
      .task-desc { white-space:pre-wrap; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h4 m-0">Kanban Tasks</h1>
          <div class="text-muted small">Board: <span id="boardName">bocpd</span></div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="/">Dashboard</a>
          <button id="refreshBtn" class="btn btn-primary btn-sm">Refresh</button>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select id="statusFilter" class="form-select form-select-sm">
              <option value="In Progress" selected>In Progress</option>
              <option value="To Do">To Do</option>
              <option value="Done">Done</option>
              <option value="">All</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Epic</label>
            <select id="epicFilter" class="form-select form-select-sm"><option value="">All</option></select>
          </div>
        </div>
        <div class="mt-2">
          <a href="#" class="badge text-bg-light me-1" data-status="">All</a>
          <a href="#" class="badge text-bg-secondary me-1" data-status="To Do">To Do</a>
          <a href="#" class="badge text-bg-warning me-1" data-status="In Progress">In Progress</a>
          <a href="#" class="badge text-bg-success" data-status="Done">Done</a>
        </div>
      </div>

      <div id="tasks" class="row g-3"></div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const params = new URLSearchParams(location.search);
      async function json(url) { const r = await fetch(url, { cache:'no-store' }); if (!r.ok) throw new Error(r.status); return r.json(); }
      let cache = [];
      function groupByEpic(rows){ const m = new Map(); for (const t of rows) { const k = t.epic||'Misc'; if (!m.has(k)) m.set(k, []); m.get(k).push(t); } return m; }
      function render(){
        const status = $('statusFilter').value;
        const epic = $('epicFilter').value;
        // push to URL for deep link
        const qp = new URLSearchParams(); if (status) qp.set('status', status); if (epic) qp.set('epic', epic); const qs = qp.toString(); history.replaceState(null, '', qs ? ('?'+qs) : location.pathname);
        const rows = cache.filter(t => (!status || t.status === status) && (!epic || t.epic === epic));
        const by = groupByEpic(rows);
        const container = $('tasks'); container.innerHTML = '';
        if (!rows.length) { container.innerHTML = '<div class="text-muted">No matching tasks.</div>'; return; }
        for (const [ep, list] of by) {
          const col = document.createElement('div'); col.className = 'col-12';
          const card = document.createElement('div'); card.className = 'card p-3';
          const h = document.createElement('div'); h.className = 'mb-2'; h.innerHTML = `<span class="badge badge-epic">Epic ${ep}</span>`; card.appendChild(h);
          for (const t of list) {
            const d = document.createElement('div'); d.className = 'mb-3';
            d.innerHTML = `<div class="task-title">${t.id} — ${t.title}</div><div class="small text-muted">${t.status} · ${t.priority||''} · ${t.size||''}</div><div class="task-desc mt-1">${(t.description||'').replace(/\n/g,'<br>')}</div>`;
            card.appendChild(d);
          }
          col.appendChild(card); container.appendChild(col);
        }
      }
      async function refresh(){
        try {
          const tasks = await json('/api/kanban/tasks?board=bocpd');
          cache = tasks||[];
          const epics = Array.from(new Set(cache.map(t => t.epic).filter(Boolean))).sort();
          $('epicFilter').innerHTML = '<option value="">All</option>' + epics.map(e=>`<option value="${e}">${e}</option>`).join('');
          render();
        } catch { $('tasks').innerHTML = '<div class="text-muted">Kanban API unavailable</div>'; }
      }
      $('refreshBtn').onclick = refresh;
      // status quick links
      for (const a of document.querySelectorAll('[data-status]')) { a.onclick = (e)=>{ e.preventDefault(); $('statusFilter').value = a.getAttribute('data-status'); render(); }; }
      $('statusFilter').onchange = render;
      $('epicFilter').onchange = render;
      // initialize from URL
      const s = params.get('status'); if (s) $('statusFilter').value = s;
      const e = params.get('epic'); if (e) $('epicFilter').value = e;
      refresh();
    </script>
  </body>
 </html>
